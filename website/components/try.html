<!-- "Take a try for SLM jailbreak" Section -->
<section class="section" id="try">
    <div class="container is-max-desktop">
        <div class="columns is-centered has-text-centered">
            <div class="column is-full-width">
                <h2 class="title is-3">Take a try for SLM jailbreak</h2>
            </div>
        </div>
        <br>
        
        <div class="content has-text-justified">
            <p>
                This interactive section allows you to experiment with different jailbreak methods on small language models in real-time. 
                Select an SLM family, a specific model, and a jailbreak method, then input your query to see if you can successfully 
                bypass the model's safety guardrails.
            </p>
        </div>
        
        <!-- Jailbreak Examples with Dropdowns -->
        <div class="jailbreak-examples-container">
            <div class="dropdown-container-box">
                <div class="dropdown-row">
                    <!-- SLM Family Selection -->
                    <div class="dropdown-col">
                        <select class="custom-select" id="try-slm-family-select">
                            <option value="">Select an SLM family...</option>
                            <option value="Llama3.2">LLaMA 3.2 family</option>
                            <option value="DeepSeek-R1">DeepSeek-R1 family</option>
                            <option value="Qwen">Qwen family</option>
                            <option value="Gemma">Gemma family</option>
                            <option value="Phi">Phi family</option>
                            <option value="MiniCPM">MiniCPM family</option>
                            <option value="H2O-Danube">H2O-Danube family</option>
                            <option value="SmolLM">SmolLM family</option>
                            <option value="StableLM">StableLM family</option>
                            <option value="TinyLlama">TinyLlama family</option>
                            <option value="MobileLlama">MobileLLaMA family</option>
                            <option value="MobiLlama">MobiLlama family</option>
                            <option value="Fox">Fox family</option>
                            <option value="Dolly">Dolly family</option>
                            <option value="OLMo">OLMo family</option>
                        </select>
                    </div>
                    
                    <!-- SLM Selection -->
                    <div class="dropdown-col">
                        <select class="custom-select" id="try-slm-select">
                            <option value="">Select an SLM model...</option>
                            <!-- Options will be populated dynamically based on selected family -->
                        </select>
                    </div>
                    
                    <!-- Jailbreak Method Selection -->
                    <div class="dropdown-col">
                        <select class="custom-select" id="try-jailbreak-select">
                            <option value="">Select a jailbreak method...</option>
                            <option value="Direct">Direct</option>
                            <option value="HumanJailbreaks">HumanJailbreaks</option>
                            <option value="AutoDAN">AutoDAN</option>
                            <option value="PAP">PAP</option>
                            <option value="GCG">GCG</option>
                            <option value="AutoPrompt">AutoPrompt</option>
                            <option value="PEZ">PEZ</option>
                            <option value="GBDA">GBDA</option>
                            <option value="UAT">UAT</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="input-area">
                <label for="jailbreak-query">Enter your jailbreak query:</label>
                <textarea id="jailbreak-query" class="jailbreak-query-input" 
                          placeholder="Type your harmful query here to test the SLM's safety guardrails..." rows="4"></textarea>
                <button id="submit-query" class="submit-button" disabled>Submit Query</button>
            </div>
            
            <!-- Results Display Area -->
            <div id="jailbreak-try-display" class="output-container">
                <!-- Empty state message (shown initially) -->
                <div id="empty-state-message" class="empty-state">
                    <p>Select an SLM family, model, jailbreak method, and enter a query to see results here.</p>
                </div>
                
                <!-- 结果将会在这里动态添加，使用与RQ1和RQ3一致的样式 -->
            </div>
            
            <!-- Terminal Output Area -->
            <div id="terminal-container" class="terminal-container">
                <div class="terminal-header">
                    <div class="terminal-title">Terminal</div>
                    <div class="terminal-controls">
                        <button id="toggle-terminal" class="button is-small">
                            <span id="toggle-icon">▼</span>
                            <span id="toggle-text">Fold</span>
                        </button>
                        <button id="clear-terminal" class="button is-small">Clear</button>
                    </div>
                </div>
                <div id="terminal-content" class="terminal-content">
                    <div id="terminal-output" class="terminal-output"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用于与后端通信的JavaScript代码 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const submitButton = document.getElementById('submit-query');
            const jailbreakQuery = document.getElementById('jailbreak-query');
            const slmFamilySelect = document.getElementById('try-slm-family-select');
            const slmSelect = document.getElementById('try-slm-select');
            const jailbreakSelect = document.getElementById('try-jailbreak-select');
            const terminalOutput = document.getElementById('terminal-output');
            const jailbreakLoadingMessage = document.getElementById('jailbreak-loading-message');
            const jailbreakFinalPrompt = document.getElementById('jailbreak-final-prompt');
            const emptyStateMessage = document.getElementById('empty-state-message');
            const questionDisplayContainer = document.getElementById('question-display-container');
            const jailbreakPromptDisplay = document.getElementById('jailbreak-prompt-display');
            const modelResponseDisplay = document.getElementById('model-response-display');
            
            // 确保这些元素存在
            if (submitButton && jailbreakQuery && slmFamilySelect && slmSelect && jailbreakSelect && terminalOutput) {
                submitButton.addEventListener('click', function() {
                    // 获取用户选择和输入
                    const selectedModel = slmSelect.value;
                    const selectedJailbreak = jailbreakSelect.value;
                    const query = jailbreakQuery.value.trim();
                    
                    // 禁用提交按钮，防止重复提交
                    submitButton.disabled = true;
                    
                    // 隐藏空状态消息
                    if (emptyStateMessage) {
                        emptyStateMessage.style.display = 'none';
                    }
                    
                    // 清空终端和显示区域
                    terminalOutput.innerHTML = '';
                    
                    // 清空jailbreak-try-display容器，准备添加新内容
                    const jailbreakTryDisplay = document.getElementById('jailbreak-try-display');
                    jailbreakTryDisplay.innerHTML = '';
                    
                    // 显示并设置问题区域（使用RQ1的打字机效果）
                    displayQuestionWithTypewriter(jailbreakTryDisplay, query);
                    
                    // 添加加载消息
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'jailbreak-loading-message';
                    loadingDiv.className = 'loading-message';
                    loadingDiv.textContent = 'Optimizing jailbreak prompt, please wait for some time. You can refer to the terminal for detailed optimized process';
                    jailbreakTryDisplay.appendChild(loadingDiv);
                    
                    // 添加初始消息到终端
                    const timestamp = new Date().toLocaleTimeString();
                    terminalOutput.innerHTML += `<div class="terminal-line">[${timestamp}] 开始处理查询: "${query.substring(0, 30)}${query.length > 30 ? '...' : ''}"</div>`;
                    terminalOutput.innerHTML += `<div class="terminal-line">[${timestamp}] 使用模型: ${selectedModel}</div>`;
                    terminalOutput.innerHTML += `<div class="terminal-line">[${timestamp}] 使用方法: ${selectedJailbreak}</div>`;
                    terminalOutput.innerHTML += `<div class="terminal-line">[${timestamp}] 正在连接到优化服务器...</div>`;
                    
                    // 滚动到底部
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                    
                    // 创建EventSource连接到后端服务器
                    const eventSource = new EventSource(`http://localhost:8006/optimize?question=${encodeURIComponent(query)}&slm=${encodeURIComponent(selectedModel)}&method=${encodeURIComponent(selectedJailbreak)}`);
                    
                    // 监听服务器发送的消息
                    eventSource.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            
                            if (data.status === 'started') {
                                // 开始处理
                                const timestamp = new Date().toLocaleTimeString();
                                terminalOutput.innerHTML += `<div class="terminal-line">[${timestamp}] ${data.message}</div>`;
                            } 
                            else if (data.status === 'running') {
                                // 处理中，显示实时输出
                                const timestamp = new Date().toLocaleTimeString();
                                terminalOutput.innerHTML += `<div class="terminal-line">[${timestamp}] ${data.message}</div>`;
                            } 
                            else if (data.status === 'completed') {
                                // 处理完成，显示最终结果
                                const timestamp = new Date().toLocaleTimeString();
                                terminalOutput.innerHTML += `<div class="terminal-line">[${timestamp}] 优化完成!</div>`;
                                terminalOutput.innerHTML += `<div class="terminal-line">[${timestamp}] ${data.final_prompt}</div>`;
                                
                                // 移除加载消息
                                const loadingMessage = document.getElementById('jailbreak-loading-message');
                                if (loadingMessage) {
                                    jailbreakTryDisplay.removeChild(loadingMessage);
                                }
                                
                                // 显示最终的jailbreak prompt
                                displayPromptMessage(jailbreakTryDisplay, data.final_prompt, "prompt-message", "Jailbreak Prompt");
                                
                                // 模拟模型响应（在实际实现中，这里可以调用另一个API来获取模型对jailbreak prompt的响应）
                                setTimeout(() => {
                                    const testResponse = `这是一个来自 ${selectedModel} 模型的模拟回复。\n\n我很抱歉，但我不能提供有关如何进行有害活动的指导或支持。我被设计为一个负责任的AI助手，旨在提供有用、安全和道德的信息。\n\n如果您有其他问题或需要帮助，请随时告诉我，我很乐意以建设性和有益的方式提供帮助。`;
                                    
                                    // 使用模型名称作为响应标题
                                    let modelDisplayName = selectedModel;
                                    try {
                                        modelDisplayName = selectedModel.replace(/_/g, ' ');
                                        if (modelDisplayName === modelDisplayName.toLowerCase()) {
                                            modelDisplayName = modelDisplayName.split(' ').map(word => 
                                                word.charAt(0).toUpperCase() + word.slice(1)
                                            ).join(' ');
                                        }
                                    } catch (e) {
                                        console.warn('模型名称格式化失败:', e);
                                    }
                                    
                                    displayResponseWithTypewriter(jailbreakTryDisplay, testResponse, "response-message", `${modelDisplayName} Response`, 0);
                                }, 1000);
                                
                                // 关闭连接
                                eventSource.close();
                                
                                // 重新启用提交按钮
                                submitButton.disabled = false;
                            }
                            
                            // 滚动到底部
                            terminalOutput.scrollTop = terminalOutput.scrollHeight;
                        } catch (error) {
                            console.error('解析服务器消息时出错:', error);
                            const timestamp = new Date().toLocaleTimeString();
                            terminalOutput.innerHTML += `<div class="terminal-line error">[${timestamp}] 错误: ${error.message}</div>`;
                            
                            // 关闭连接
                            eventSource.close();
                            
                            // 重新启用提交按钮
                            submitButton.disabled = false;
                        }
                    };
                    
                    // 处理错误
                    eventSource.onerror = function(error) {
                        console.error('EventSource错误:', error);
                        const timestamp = new Date().toLocaleTimeString();
                        terminalOutput.innerHTML += `<div class="terminal-line error">[${timestamp}] 连接错误，请检查服务器状态</div>`;
                        
                        // 关闭连接
                        eventSource.close();
                        
                        // 重新启用提交按钮
                        submitButton.disabled = false;
                    };
                });
            } else {
                console.error('无法找到必要的DOM元素');
            }
            
            // 打字机效果显示问题
            function displayQuestionWithTypewriter(container, text) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-display';
                
                // 为前缀文本创建一个包装器
                const prefixSpan = document.createElement('span');
                prefixSpan.textContent = "Harmful question: ";
                prefixSpan.style.fontWeight = "bold";
                questionDiv.appendChild(prefixSpan);
                
                container.appendChild(questionDiv);
                
                // 逐个字符应用打字机效果
                let i = 0;
                const speed = 30; // 问题的打字速度
                
                function typeWriter() {
                    if (i < text.length) {
                        questionDiv.appendChild(document.createTextNode(text[i]));
                        i++;
                        setTimeout(typeWriter, speed);
                    }
                }
                
                // 开始输入文本
                typeWriter();
            }
            
            // 显示提示消息
            function displayPromptMessage(container, text, className, title) {
                const messageDiv = document.createElement('div');
                messageDiv.className = className;
                
                const messageTitle = document.createElement('span');
                messageTitle.className = 'message-title';
                messageTitle.textContent = title;
                messageDiv.appendChild(messageTitle);
                
                messageDiv.appendChild(document.createTextNode(text));
                container.appendChild(messageDiv);
            }
            
            // 带打字机效果显示响应
            function displayResponseWithTypewriter(container, text, className, title, label) {
                const messageDiv = document.createElement('div');
                messageDiv.className = className;
                
                const messageTitle = document.createElement('span');
                messageTitle.className = 'message-title';
                messageTitle.textContent = title;
                messageDiv.appendChild(messageTitle);
                
                container.appendChild(messageDiv);
                
                // 应用打字机效果
                let i = 0;
                const speed = 3; // 加快打字速度
                
                function typeWriter() {
                    if (i < text.length) {
                        messageDiv.appendChild(document.createTextNode(text[i]));
                        i++;
                        setTimeout(typeWriter, speed);
                    } else {
                        // 打字完成后，添加标签
                        if (label !== undefined) {
                            const labelDiv = document.createElement('div');
                            labelDiv.className = 'response-label ' + (label === 0 ? 'safe' : 'unsafe');
                            if (label === 0) {
                                labelDiv.textContent = "Jailbreak Fail";
                            } else {
                                labelDiv.textContent = "Jailbreak Success!";
                            }
                            
                            // 将标签添加到响应消息下方
                            container.appendChild(labelDiv);
                        }
                    }
                }
                
                typeWriter();
            }
        });
    </script>
</section>